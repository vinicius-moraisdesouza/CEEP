{% extends 'base.html' %} 
{% load static %}

{% block content %}
<div class="container mt-5">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">Análise Final do Dossiê</h2>
            <p class="h5 text-muted">Aluno(a): {{ aluno.get_full_name }}</p>
        </div>
        <a href="{% url 'servidor_dashboard' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i> Voltar ao Dashboard
        </a>
    </div>

    {% if estagio.status_geral == 'APROVADO' %}
        <div class="alert alert-success shadow-sm">
            <i class="bi bi-check-circle-fill me-2"></i>
            <strong>Dossiê Aprovado!</strong> Este processo foi finalizado com sucesso.
        </div>
    {% elif estagio.status_geral == 'PENDENTE_CORRECAO' %}
        <div class="alert alert-danger shadow-sm">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>Dossiê Reprovado.</strong> Aguardando correções do aluno.
        </div>
    {% elif estagio.status_geral == 'AGUARDANDO_SERVIDOR' %}
        <div class="alert alert-primary shadow-sm">
            <i class="bi bi-hourglass-split me-2"></i>
            <strong>Aguardando Análise.</strong> Este dossiê requer sua assinatura e aprovação final.
        </div>
    {% endif %}
    
    <hr class="my-4">

    <h3 class="mb-3">Checklist de Documentos</h3>
    
    <div class="list-group shadow-sm">
        {% for doc in documentos %}
        <div class="list-group-item">
            <div class="row align-items-center">
                
                <div class="col-md-4">
                    <strong>{{ doc.get_tipo_documento_display }}</strong>
                </div>

                <div class="col-md-5">
                    <small class="d-block {% if doc.assinado_aluno_em %}text-success{% else %}text-muted{% endif %}">
                        <i class="bi {% if doc.assinado_aluno_em %}bi-check-circle-fill{% else %}bi-circle{% endif %} me-2"></i>
                        Assinado pelo Aluno
                    </small>
                    <small class="d-block {% if doc.assinado_orientador_em %}text-success{% else %}text-muted{% endif %}">
                        <i class="bi {% if doc.assinado_orientador_em %}bi-check-circle-fill{% else %}bi-circle{% endif %} me-2"></i>
                        Assinado pelo Orientador
                    </small>
                    <small class="d-block {% if doc.assinado_diretor_em %}text-success{% else %}text-muted{% endif %}">
                        <i class="bi {% if doc.assinado_diretor_em %}bi-check-circle-fill{% else %}bi-circle{% endif %} me-2"></i>
                        Assinado pela Direção
                    </small>
                </div>

                <div class="col-md-3 text-end">
                    
                    <a href="#" class="btn btn-sm btn-outline-secondary me-2" title="Visualizar Documento">
                        <i class="bi bi-eye-fill"></i> Visualizar
                    </a>

                    {% if doc.tipo_documento == 'TERMO_COMPROMISSO' and not doc.assinado_diretor_em and estagio.status_geral == 'AGUARDANDO_SERVIDOR' %}
                        <a href="#" class="btn btn-sm btn-primary" title="Assinar como Diretor(a)">
                           <i class="bi bi-pen-fill"></i> Assinar
                        </a>
                    {% endif %}
                </div>

            </div>
        </div>
        {% endfor %}
    </div>


    {% if estagio.status_geral == 'AGUARDANDO_SERVIDOR' %}
    <div class="card shadow-sm mt-5">
        <div class="card-body">
            <h4 class="card-title">Aprovação Final do Dossiê</h4>
            <p class="card-text text-muted">
                Após revisar todos os documentos e aplicar sua assinatura no Termo de Compromisso,
                você pode aprovar o dossiê para finalizar o processo.
            </p>
            
            <div class="d-flex gap-3">
                <a href="#" 
                   class="btn btn-success btn-lg {% if not pode_aprovar_final %}disabled{% endif %}"
                   {% if not pode_aprovar_final %} 
                       title="Você precisa assinar o Termo de Compromisso primeiro" 
                       tabindex="-1" 
                       aria-disabled="true" 
                   {% endif %}>
                    <i class="bi bi-check-circle-fill me-2"></i> Aprovar Dossiê
                </a>
                
                <a href="#" class="btn btn-danger btn-lg">
                    <i class="bi bi-x-circle-fill me-2"></i> Devolver para Correção
                </a>
            </div>
            
        </div>
    </div>
    {% endif %}

</div>
{% endblock content %}